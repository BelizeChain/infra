version: '3.8'

services:
  # BelizeChain Blockchain Node
  belizechain-node:
    build:
      context: ..
      dockerfile: infra/Dockerfile.node
    container_name: belizechain-node
    ports:
      - "${P2P_PORT:-30333}:30333"  # P2P port
      - "${RPC_PORT:-9933}:9933"    # RPC port
      - "${WS_PORT:-9944}:9944"     # WebSocket port
    volumes:
      - blockchain-data:/data
      - ./chain-spec-dev.json:/app/chain-spec.json
    environment:
      - RUST_LOG=${LOG_LEVEL:-info}
      - BELIZECHAIN_CHAIN=${CHAIN:-dev}
      - BELIZECHAIN_BASE_PATH=${BASE_PATH:-/data}
      - NODE_NAME=${NODE_NAME:-BelizeChain-Node-1}
      
      # Runtime Pallets Configuration
      - ENABLE_PALLET_ECONOMY=true
      - ENABLE_PALLET_BELIZEX=true
      - ENABLE_PALLET_PAYROLL=true
      - ENABLE_PALLET_GOVERNANCE=true
      - ENABLE_PALLET_COMMUNITY=true
      - ENABLE_PALLET_IDENTITY=true
      - ENABLE_PALLET_COMPLIANCE=true
      - ENABLE_PALLET_ORACLE=true
      - ENABLE_PALLET_STAKING=true
      - ENABLE_PALLET_CONSENSUS=true
      - ENABLE_PALLET_INTEROPERABILITY=true
      - ENABLE_PALLET_QUANTUM=true
      - ENABLE_PALLET_MESH=true
      - ENABLE_PALLET_LANDLEDGER=true
      - ENABLE_PALLET_BNS=true
      - ENABLE_PALLET_CONTRACTS=true
      
      # Meshtastic LoRa Mesh Network
      - MESH_NETWORK_ENABLED=${MESH_NETWORK_ENABLED:-false}
      - MESH_NODE_ID=${MESH_NODE_ID}
      - MESH_CHANNEL=${MESH_CHANNEL:-BelizeChain}
      
      # Performance & Consensus
      - TARGET_TPS=${TARGET_TPS:-2000}
      - BLOCK_TIME=${BLOCK_TIME:-6}
      - MAX_BLOCK_SIZE=${MAX_BLOCK_SIZE:-5242880}
    command: >
      --base-path ${BASE_PATH:-/data}
      --chain /app/chain-spec.json
      --port 30333
      --rpc-port 9933
      --ws-port 9944
      --rpc-cors all
      --unsafe-rpc-external
      --unsafe-ws-external
      ${VALIDATOR:+--validator}
      --alice
    restart: unless-stopped
    networks:
      - belizechain

  # IPFS Node for Decentralized Storage
  ipfs:
    image: ipfs/go-ipfs:latest
    container_name: belizechain-ipfs
    ports:
      - "${IPFS_SWARM_PORT:-4001}:4001"    # IPFS swarm port
      - "${IPFS_API_PORT:-5001}:5001"      # API port
      - "${IPFS_GATEWAY_PORT:-8082}:8080"  # Gateway port (changed to avoid port conflict)
    volumes:
      - ipfs-data:/data/ipfs
      - ipfs-staging:/export
    environment:
      - IPFS_PROFILE=${IPFS_PROFILE:-server}
    restart: unless-stopped
    networks:
      - belizechain

  # Federated Learning Aggregator (Nawal)
  nawal:
    build:
      context: ..
      dockerfile: infra/Dockerfile.fl-server
    container_name: belizechain-nawal
    ports:
      - "${NAWAL_API_PORT:-8080}:8080"
    volumes:
      - fl-models:/app/models
      - ./nawal:/app/nawal
    environment:
      - NAWAL_API_HOST=${NAWAL_API_HOST:-0.0.0.0}
      - NAWAL_API_PORT=8080
      - NAWAL_MIN_PARTICIPANTS=${NAWAL_MIN_PARTICIPANTS:-3}
      - NAWAL_MAX_PARTICIPANTS=${NAWAL_MAX_PARTICIPANTS:-100}
      - NAWAL_ROUNDS_PER_EPOCH=${NAWAL_ROUNDS_PER_EPOCH:-10}
      - NAWAL_MIN_FIT_CLIENTS=${NAWAL_MIN_FIT_CLIENTS:-2}
      
      # Differential Privacy (DP-SGD)
      - DIFFERENTIAL_PRIVACY_ENABLED=${DIFFERENTIAL_PRIVACY_ENABLED:-true}
      - DP_NOISE_MULTIPLIER=${DP_NOISE_MULTIPLIER:-1.1}
      - DP_MAX_GRAD_NORM=${DP_MAX_GRAD_NORM:-1.0}
      - DP_DELTA=${DP_DELTA:-1e-5}
      
      # Genetic Algorithm Model Evolution
      - GENETIC_ALGORITHM_ENABLED=${GENETIC_ALGORITHM_ENABLED:-true}
      - GA_POPULATION_SIZE=${GA_POPULATION_SIZE:-10}
      - GA_GENERATIONS=${GA_GENERATIONS:-5}
      - GA_MUTATION_RATE=${GA_MUTATION_RATE:-0.1}
      
      # Byzantine Detection & Security
      - BYZANTINE_DETECTION_ENABLED=${BYZANTINE_DETECTION_ENABLED:-true}
      - GRADIENT_VERIFICATION_ENABLED=${GRADIENT_VERIFICATION_ENABLED:-true}
      - DATA_POISONING_DETECTION=${DATA_POISONING_DETECTION:-true}
      - DATA_LEAKAGE_DETECTION=${DATA_LEAKAGE_DETECTION:-true}
      
      # Integration
      - IPFS_API=${IPFS_API:-http://ipfs:5001}
      - BLOCKCHAIN_RPC=${BLOCKCHAIN_RPC:-ws://belizechain-node:9944}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-belizechain}
      - POSTGRES_USER=${POSTGRES_USER:-belizechain}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    depends_on:
      - ipfs
      - belizechain-node
      - postgres
      - redis
    restart: unless-stopped
    networks:
      - belizechain

  # PostgreSQL Database for Compliance Data
  postgres:
    image: postgres:15-alpine
    container_name: belizechain-postgres
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./infra/sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-belizechain}
      - POSTGRES_USER=${POSTGRES_USER:-belizechain}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set in .env file}
    restart: unless-stopped
    networks:
      - belizechain

  # Redis for Caching and Session Management
  redis:
    image: redis:7-alpine
    container_name: belizechain-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD must be set in .env file}
    restart: unless-stopped
    networks:
      - belizechain

  # Quantum Computing Service (Kinich)
  kinich:
    build:
      context: ..
      dockerfile: infra/Dockerfile.quantum
    container_name: belizechain-kinich
    ports:
      - "${KINICH_API_PORT:-8888}:8888"
    volumes:
      - quantum-results:/app/results
      - ./kinich:/app/kinich
    environment:
      - KINICH_API_HOST=${KINICH_API_HOST:-0.0.0.0}
      - KINICH_API_PORT=8888
      - KINICH_MAX_CONCURRENT_JOBS=${KINICH_MAX_CONCURRENT_JOBS:-10}
      - KINICH_DEFAULT_BACKEND=${KINICH_DEFAULT_BACKEND:-qasm_simulator}
      - KINICH_ENABLE_ERROR_MITIGATION=${KINICH_ENABLE_ERROR_MITIGATION:-true}
      
      # Azure Quantum (Primary Backend)
      - AZURE_QUANTUM_ENABLED=${AZURE_QUANTUM_ENABLED:-true}
      - AZURE_QUANTUM_SUBSCRIPTION_ID=${AZURE_QUANTUM_SUBSCRIPTION_ID}
      - AZURE_QUANTUM_RESOURCE_GROUP=${AZURE_QUANTUM_RESOURCE_GROUP}
      - AZURE_QUANTUM_WORKSPACE=${AZURE_QUANTUM_WORKSPACE}
      - AZURE_QUANTUM_LOCATION=${AZURE_QUANTUM_LOCATION:-eastus}
      
      # IBM Quantum (Fallback Backend)
      - IBM_QUANTUM_ENABLED=${IBM_QUANTUM_ENABLED:-false}
      - IBM_QUANTUM_TOKEN=${IBM_QUANTUM_TOKEN}
      - IBM_QUANTUM_HUB=${IBM_QUANTUM_HUB:-ibm-q}
      - IBM_QUANTUM_GROUP=${IBM_QUANTUM_GROUP:-open}
      - IBM_QUANTUM_PROJECT=${IBM_QUANTUM_PROJECT:-main}
      
      # Circuit Optimization
      - CIRCUIT_OPTIMIZATION_LEVEL=${CIRCUIT_OPTIMIZATION_LEVEL:-3}
      - MAX_QUBITS=${MAX_QUBITS:-127}
      - MAX_SHOTS=${MAX_SHOTS:-100000}
      
      # Error Mitigation - Zero Noise Extrapolation (ZNE)
      - ZNE_ENABLED=${ZNE_ENABLED:-true}
      - ZNE_NOISE_FACTORS=${ZNE_NOISE_FACTORS:-[1,2,3]}
      
      # Error Mitigation - Readout Mitigation
      - READOUT_MITIGATION_ENABLED=${READOUT_MITIGATION_ENABLED:-true}
      - BLOCKCHAIN_RPC=${BLOCKCHAIN_RPC:-ws://belizechain-node:9944}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-belizechain}
      - POSTGRES_USER=${POSTGRES_USER:-belizechain}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    depends_on:
      - belizechain-node
      - postgres
    restart: unless-stopped
    networks:
      - belizechain

  # Pakit Decentralized Storage Service
  pakit:
    build:
      context: ..
      dockerfile: infra/Dockerfile.pakit
    container_name: belizechain-pakit
    ports:
      - "${PAKIT_API_PORT:-8001}:8001"
    volumes:
      - pakit-dag-storage:/app/storage
      - pakit-cache:/app/cache
    environment:
      # API Configuration
      - PAKIT_API_HOST=${PAKIT_API_HOST:-0.0.0.0}
      - PAKIT_API_PORT=8001
      - PAKIT_ENV=${PAKIT_ENV:-production}
      
      # Storage Configuration
      - STORAGE_DIR=/app/storage
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-104857600}  # 100MB
      - ENABLE_COMPRESSION=${ENABLE_COMPRESSION:-true}
      - COMPRESSION_ALGORITHMS=${COMPRESSION_ALGORITHMS:-zstd,lz4,snappy}
      - ENABLE_DEDUPLICATION=${ENABLE_DEDUPLICATION:-true}
      - CHUNK_SIZE=${CHUNK_SIZE:-4194304}  # 4MB
      
      # Public Access Mode
      - PAKIT_PUBLIC_MODE=${PAKIT_PUBLIC_MODE:-view-only}
      - PUBLIC_UPLOAD_ENABLED=${PUBLIC_UPLOAD_ENABLED:-false}
      - PUBLIC_DOWNLOAD_ENABLED=${PUBLIC_DOWNLOAD_ENABLED:-false}
      
      # Blockchain Integration
      - BLOCKCHAIN_ENABLED=${BLOCKCHAIN_ENABLED:-false}
      - BLOCKCHAIN_RPC=${BLOCKCHAIN_RPC:-ws://belizechain-node:9944}
      - REQUIRE_BELIZEID_FOR_PROOFS=${REQUIRE_BELIZEID_FOR_PROOFS:-true}
      
      # Sovereign DAG Backend (PRIMARY)
      - DAG_BACKEND_ENABLED=${DAG_BACKEND_ENABLED:-true}
      - DAG_REPLICATION_FACTOR=${DAG_REPLICATION_FACTOR:-3}
      - DAG_QUANTUM_COMPRESSION=${DAG_QUANTUM_COMPRESSION:-true}
      
      # ZK Proof Support
      - ZK_PROOF_ENABLED=${ZK_PROOF_ENABLED:-true}
      - ZK_PROOF_SYSTEM=${ZK_PROOF_SYSTEM:-groth16}
      - ZK_VERIFY_ON_UPLOAD=${ZK_VERIFY_ON_UPLOAD:-false}
      - ZK_PROOF_CACHE_DIR=/app/cache/zk-proofs
      
      # IPFS Backend (OPTIONAL)
      - IPFS_ENABLED=${IPFS_ENABLED:-false}
      - IPFS_API=${IPFS_API:-http://ipfs:5001}
      
      # Arweave Backend (OPTIONAL)
      - ARWEAVE_ENABLED=${ARWEAVE_ENABLED:-false}
      
      # Cache Settings
      - CACHE_DIR=/app/cache
      - CACHE_MAX_SIZE=${CACHE_MAX_SIZE:-10737418240}  # 10GB
      - CACHE_TTL=${CACHE_TTL:-3600}  # 1 hour
      
      # Database Connection
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-belizechain}
      - POSTGRES_USER=${POSTGRES_USER:-belizechain}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      
      # Redis Connection
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    depends_on:
      - ipfs
      - postgres
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - belizechain

  # Blue Hole Portal (Government Dashboard)
  blue-hole-portal:
    build:
      context: ..
      dockerfile: infra/Dockerfile.ui
      args:
        APP_NAME: blue-hole-portal
    container_name: belizechain-blue-hole
    ports:
      - "3000:3000"
    volumes:
      - ./ui/blue-hole-portal/src:/app/src
      - ./ui/blue-hole-portal/public:/app/public
    environment:
      - NEXT_PUBLIC_BLOCKCHAIN_RPC=${NEXT_PUBLIC_BLUEHOLE_BLOCKCHAIN_RPC:-http://localhost:9933}
      - NEXT_PUBLIC_BLOCKCHAIN_WS=${NEXT_PUBLIC_BLUEHOLE_BLOCKCHAIN_WS:-ws://localhost:9944}
      - NEXT_PUBLIC_IPFS_GATEWAY=${NEXT_PUBLIC_IPFS_GATEWAY:-http://localhost:8082}
      - NEXT_PUBLIC_NAWAL_API=${NEXT_PUBLIC_NAWAL_API:-http://localhost:8080}
      - NEXT_PUBLIC_KINICH_API=${NEXT_PUBLIC_KINICH_API:-http://localhost:8888}
    depends_on:
      - belizechain-node
      - ipfs
    restart: unless-stopped
    networks:
      - belizechain

  # Maya Wallet (Citizen Portal)
  maya-wallet:
    build:
      context: ..
      dockerfile: infra/Dockerfile.ui
      args:
        APP_NAME: maya-wallet
    container_name: belizechain-maya-wallet
    ports:
      - "3001:3001"
    volumes:
      - ./ui/maya-wallet/src:/app/src
      - ./ui/maya-wallet/public:/app/public
    environment:
      - NEXT_PUBLIC_BLOCKCHAIN_RPC=${NEXT_PUBLIC_MAYA_BLOCKCHAIN_RPC:-http://localhost:9933}
      - NEXT_PUBLIC_BLOCKCHAIN_WS=${NEXT_PUBLIC_MAYA_BLOCKCHAIN_WS:-ws://localhost:9944}
      - NEXT_PUBLIC_IPFS_GATEWAY=${NEXT_PUBLIC_IPFS_GATEWAY:-http://localhost:8082}
      - NEXT_PUBLIC_NAWAL_API=${NEXT_PUBLIC_NAWAL_API:-http://localhost:8080}
      - NEXT_PUBLIC_KINICH_API=${NEXT_PUBLIC_KINICH_API:-http://localhost:8888}
      - NEXT_PUBLIC_PAKIT_API=${NEXT_PUBLIC_PAKIT_API:-http://localhost:8001}
    depends_on:
      - belizechain-node
    restart: unless-stopped
    networks:
      - belizechain

  # Monitoring with Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: belizechain-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    restart: unless-stopped
    networks:
      - belizechain

  # Monitoring with Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: belizechain-grafana
    ports:
      - "3003:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./infra/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./infra/grafana/datasources:/etc/grafana/provisioning/datasources
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:?GRAFANA_ADMIN_PASSWORD must be set in .env file}
      - GF_USERS_ALLOW_SIGN_UP=${GRAFANA_USERS_ALLOW_SIGN_UP:-false}
    depends_on:
      - prometheus
    restart: unless-stopped
    networks:
      - belizechain

# Named volumes for persistent data
volumes:
  blockchain-data:
    driver: local
  ipfs-data:
    driver: local
  ipfs-staging:
    driver: local
  fl-models:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local
  quantum-results:
    driver: local
  pakit-dag-storage:
    driver: local
  pakit-cache:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

# Network for all BelizeChain services
networks:
  belizechain:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16