version: '3.8'

services:
  nawal-server:
    image: belizechain/nawal:latest
    build:
      context: ../
      dockerfile: nawal/Dockerfile
    container_name: nawal-fl-server
    ports:
      - "8080:8080"
    volumes:
      - fl-models:/app/models
      - fl-checkpoints:/app/checkpoints
      - fl-data:/app/data
    environment:
      # API Configuration
      - NAWAL_API_HOST=0.0.0.0
      - NAWAL_API_PORT=8080
      - NAWAL_ENV=development
      
      # Federated Learning Settings
      - NAWAL_MIN_PARTICIPANTS=2
      - NAWAL_MAX_PARTICIPANTS=100
      - NAWAL_ROUNDS_PER_EPOCH=10
      - NAWAL_MIN_FIT_CLIENTS=2
      - NAWAL_MIN_AVAILABLE_CLIENTS=2
      
      # External Services (FQDN for cross-namespace)
      - BLOCKCHAIN_RPC=ws://belizechain-node.belizechain.svc.cluster.local:9944
      - IPFS_API=http://ipfs.belizechain.svc.cluster.local:5001
      - POSTGRES_HOST=postgres.belizechain.svc.cluster.local
      - POSTGRES_PORT=5432
      - POSTGRES_DB=belizechain
      - POSTGRES_USER=belizechain
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - REDIS_HOST=redis.belizechain.svc.cluster.local
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      
      # Privacy Settings
      - DIFFERENTIAL_PRIVACY_ENABLED=true
      - DP_NOISE_MULTIPLIER=1.1
      - DP_MAX_GRAD_NORM=1.0
      - DP_DELTA=1e-5
      
      # Model Settings
      - MODEL_TYPE=belizechain-llm
      - MODEL_HIDDEN_SIZE=768
      - MODEL_NUM_LAYERS=12
      - MODEL_NUM_HEADS=12
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      ipfs:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    networks:
      - nawal-net
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    # Uncomment for GPU support
    # runtime: nvidia
    # environment:
    #   - NVIDIA_VISIBLE_DEVICES=all
    #   - CUDA_VISIBLE_DEVICES=0

  postgres:
    image: postgres:15-alpine
    container_name: nawal-postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ../sql/init_nawal.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      - POSTGRES_DB=belizechain
      - POSTGRES_USER=belizechain
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --lc-collate=C --lc-ctype=C
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U belizechain"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - nawal-net

  redis:
    image: redis:7-alpine
    container_name: nawal-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-changeme}
      --appendonly yes
      --appendfsync everysec
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - nawal-net

  ipfs:
    image: ipfs/kubo:latest
    container_name: nawal-ipfs
    ports:
      - "4001:4001"     # Swarm
      - "5001:5001"     # API
      - "8082:8080"     # Gateway
    volumes:
      - ipfs-data:/data/ipfs
      - ipfs-staging:/export
    environment:
      - IPFS_PROFILE=server
      - IPFS_PATH=/data/ipfs
    restart: unless-stopped
    networks:
      - nawal-net

volumes:
  fl-models:
    driver: local
  fl-checkpoints:
    driver: local
  fl-data:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local
  ipfs-data:
    driver: local
  ipfs-staging:
    driver: local

networks:
  nawal-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16
