name: Helm Chart Lint & Test

on:
  push:
    branches: [main]
    paths:
      - 'helm/**'
      - '.github/workflows/helm-lint.yml'
  pull_request:
    branches: [main]
    paths:
      - 'helm/**'
  workflow_dispatch:

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.14.0'
      
      - name: Lint Helm chart (default values)
        run: |
          echo "Linting with default values..."
          helm lint helm/belizechain
      
      - name: Lint Helm chart (dev values)
        run: |
          echo "Linting with dev values..."
          helm lint helm/belizechain -f helm/belizechain/values-dev.yaml
      
      - name: Lint Helm chart (staging values)
        run: |
          echo "Linting with staging values..."
          helm lint helm/belizechain -f helm/belizechain/values-staging.yaml
      
      - name: Lint Helm chart (production values)
        run: |
          echo "Linting with production values..."
          helm lint helm/belizechain -f helm/belizechain/values-production.yaml
      
      - name: Lint Helm chart (GPU values)
        run: |
          echo "Linting with GPU values..."
          helm lint helm/belizechain -f helm/belizechain/values-gpu.yaml
      
      - name: Lint Helm chart (quantum values)
        run: |
          echo "Linting with quantum values..."
          helm lint helm/belizechain -f helm/belizechain/values-quantum.yaml
      
      - name: Template validation (default)
        run: |
          echo "Validating templates with default values..."
          helm template test helm/belizechain --debug > /dev/null
      
      - name: Template validation (GPU)
        run: |
          echo "Validating templates with GPU values..."
          helm template test helm/belizechain -f helm/belizechain/values-gpu.yaml --debug > /dev/null
      
      - name: Template validation (quantum)
        run: |
          echo "Validating templates with quantum values..."
          helm template test helm/belizechain -f helm/belizechain/values-quantum.yaml --debug > /dev/null
      
      - name: Package Helm chart
        run: |
          echo "Packaging chart..."
          helm package helm/belizechain
      
      - name: Upload chart artifact
        uses: actions/upload-artifact@v3
        with:
          name: helm-chart
          path: belizechain-*.tgz
          retention-days: 7
      
      - name: Verify package integrity
        run: |
          echo "Verifying packaged chart..."
          helm lint belizechain-*.tgz

  kubernetes-validation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Kubernetes tools
        run: |
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          
          # Install kubeval for YAML validation
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin/
      
      - name: Validate Kubernetes manifests
        run: |
          echo "Validating base manifests..."
          find k8s/base -name "*.yaml" -type f -exec kubeval --strict {} \;
          
          echo "Validating Istio manifests..."
          find k8s/istio -name "*.yaml" -type f -exec kubeval --strict --ignore-missing-schemas {} \;
      
      - name: Validate ArgoCD applications
        run: |
          echo "Validating ArgoCD manifests..."
          kubeval --strict argocd/*.yaml
