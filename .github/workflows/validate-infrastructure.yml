name: Infrastructure Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  yaml-lint:
    name: YAML Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install yamllint
        run: pip install yamllint
      
      - name: Lint YAML files
        run: |
          yamllint -c .yamllint \
            docker-compose.yml \
            helm/ \
            k8s/ \
            argocd/ \
            grafana/ || true

  helm-validation:
    name: Helm Chart Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.14.0'
      
      - name: Lint Helm charts
        run: |
          helm lint helm/belizechain \
            --values helm/belizechain/values.yaml \
            --values helm/belizechain/values-dev.yaml
      
      - name: Lint production values
        run: |
          helm lint helm/belizechain \
            --values helm/belizechain/values-production.yaml
      
      - name: Template dry-run
        run: |
          helm template belizechain helm/belizechain \
            --values helm/belizechain/values.yaml \
            --dry-run > /dev/null

  kubernetes-validation:
    name: Kubernetes Manifest Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Validate Kubernetes manifests
        run: |
          kubectl apply --dry-run=client -k k8s/base/ || true
      
      - name: Validate ArgoCD applications
        run: |
          for file in argocd/*.yaml; do
            kubectl apply --dry-run=client -f "$file" || true
          done

  docker-compose-validation:
    name: Docker Compose Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate docker-compose.yml syntax
        run: |
          # Validate YAML syntax only (skip build context validation)
          python3 -c "import yaml; yaml.safe_load(open('docker-compose.yml'))"
          echo "✅ docker-compose.yml is valid YAML"
      
      - name: Check for required services
        run: |
          if ! grep -q "belizechain-node" docker-compose.yml; then
            echo "❌ Missing blockchain node service"
            exit 1
          fi
          if ! grep -q "nawal" docker-compose.yml; then
            echo "❌ Missing Nawal AI service"
            exit 1
          fi
          if ! grep -q "pakit" docker-compose.yml; then
            echo "❌ Missing Pakit storage service"
            exit 1
          fi
          echo "✅ All required services defined"

  secrets-check:
    name: Check for Secrets/Leaks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for secrets in files (TruffleHog)
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || 'main' }}
          head: HEAD
          extra_args: --no-verification
      
      - name: Simple secrets pattern check
        run: |
          echo "Checking for common secret patterns..."
          
          # Check for hardcoded passwords, tokens, keys (but exclude template files)
          FOUND_SECRETS=0
          
          # Check for suspicious patterns in committed files
          if git ls-files | xargs grep -iE "password\s*=\s*['\"][^'\"]+['\"]" 2>/dev/null | grep -v ".env.example" | grep -v "service-discovery.env"; then
            echo "⚠️  Found hardcoded password patterns"
            FOUND_SECRETS=1
          fi
          
          if git ls-files | xargs grep -iE "(api[_-]?key|secret[_-]?key)\s*=\s*['\"][a-zA-Z0-9]{20,}" 2>/dev/null | grep -v ".env.example"; then
            echo "⚠️  Found potential API key patterns"
            FOUND_SECRETS=1
          fi
          
          if [ $FOUND_SECRETS -eq 0 ]; then
            echo "✅ No obvious hardcoded secrets found"
          else
            echo "⚠️  Note: These might be false positives. Review manually."
          fi
      
      - name: Verify .gitignore exists
        run: |
          if [ ! -f .gitignore ]; then
            echo "❌ .gitignore is missing!"
            exit 1
          fi
          echo "✅ .gitignore exists"
      
      - name: Check for common secret files
        run: |
          # Exclude service-discovery.env (contains DNS templates, not secrets)
          if find . -name "*.env" \
            -not -name ".env.example" \
            -not -name "service-discovery.env" \
            -not -path "./.git/*" | grep -q .; then
            echo "⚠️  Warning: Found .env files (should be gitignored)"
            find . -name "*.env" \
              -not -name ".env.example" \
              -not -name "service-discovery.env" \
              -not -path "./.git/*"
            exit 1
          else
            echo "✅ No secret .env files found in repository"
          fi
      
      - name: Verify service-discovery.env is safe
        run: |
          if [ -f shared/service-discovery.env ]; then
            echo "Checking service-discovery.env for actual secrets..."
            # Check for actual secret values (long alphanumeric strings), not just variable names
            if grep -E "=['\"]?[a-zA-Z0-9]{32,}['\"]?" shared/service-discovery.env | grep -v "FQDN\|HTTP\|localhost\|belizechain"; then
              echo "❌ service-discovery.env appears to contain actual secrets!"
              exit 1
            fi
            echo "✅ service-discovery.env contains only DNS templates"
          else
            echo "ℹ️  service-discovery.env not found (might be gitignored)"
          fi
