version: '3.8'

services:
  pakit-storage:
    image: belizechain/pakit:latest
    build:
      context: ../
      dockerfile: pakit/Dockerfile
    container_name: pakit-storage-node
    ports:
      - "8001:8001"
    volumes:
      - pakit-dag-storage:/app/storage
      - pakit-cache:/app/cache
    environment:
      # API Configuration
      - PAKIT_API_HOST=0.0.0.0
      - PAKIT_API_PORT=8001
      - PAKIT_ENV=development
      
      # Storage Configuration
      - STORAGE_DIR=/app/storage
      - MAX_FILE_SIZE=104857600  # 100MB
      - ENABLE_COMPRESSION=true
      - COMPRESSION_ALGORITHMS=zstd,lz4,snappy
      - ENABLE_DEDUPLICATION=true
      - CHUNK_SIZE=4194304  # 4MB
      
      # View-Only Public Mode (list/view only, all actions require BelizeID)
      - PAKIT_PUBLIC_MODE=view-only
      - PUBLIC_UPLOAD_ENABLED=false
      - PUBLIC_DOWNLOAD_ENABLED=false
      
      # Blockchain Integration (OPTIONAL - for proof registration)
      - BLOCKCHAIN_ENABLED=${BLOCKCHAIN_ENABLED:-false}
      - BLOCKCHAIN_RPC=ws://belizechain-node.belizechain.svc.cluster.local:9944
      - REQUIRE_BELIZEID_FOR_PROOFS=true
      
      # Sovereign DAG Backend (PRIMARY - 100% sovereign)
      - DAG_BACKEND_ENABLED=true
      - DAG_REPLICATION_FACTOR=3
      - DAG_QUANTUM_COMPRESSION=true
      
      # IPFS Backend (OPTIONAL - fallback only)
      - IPFS_ENABLED=${IPFS_ENABLED:-false}
      - IPFS_API=http://ipfs.belizechain.svc.cluster.local:5001
      
      # Arweave Backend (OPTIONAL - disabled by default)
      - ARWEAVE_ENABLED=false
      
      # Cache Settings
      - CACHE_DIR=/app/cache
      - CACHE_MAX_SIZE=10737418240  # 10GB
      - CACHE_TTL=3600  # 1 hour
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - pakit-net

  # IPFS is optional - only start if IPFS_ENABLED=true
  ipfs:
    image: ipfs/kubo:latest
    container_name: pakit-ipfs
    ports:
      - "4002:4001"     # Swarm (different port to avoid conflict)
      - "5002:5001"     # API
      - "8083:8080"     # Gateway
    volumes:
      - ipfs-data:/data/ipfs
      - ipfs-staging:/export
    environment:
      - IPFS_PROFILE=server
      - IPFS_PATH=/data/ipfs
    restart: unless-stopped
    networks:
      - pakit-net
    profiles:
      - ipfs  # Only start if explicitly enabled

volumes:
  pakit-dag-storage:
    driver: local
  pakit-cache:
    driver: local
  ipfs-data:
    driver: local
  ipfs-staging:
    driver: local

networks:
  pakit-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.24.0.0/16
